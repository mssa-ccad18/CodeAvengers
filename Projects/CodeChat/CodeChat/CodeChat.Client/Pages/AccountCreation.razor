@page "/create-account"
@rendermode InteractiveWebAssembly
@layout Layout.LoginLayout
@using Microsoft.AspNetCore.SignalR.Client
@using System.Diagnostics
@using System.Text.Json
@using CodeChat.Client.Components.Models
@inject NavigationManager Navigation
@inject IJSRuntime _jsRuntime
@implements IAsyncDisposable

@* injects for error handling and status message update from ChatHub.cs> *@
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<PageTitle>CodeChat - Connect with Developers</PageTitle>
<link href="css/home.css" rel="stylesheet" />
<script src="crypto.js"></script>



<div class="account-create-container">
    <div class="login-container" >
        <div class="login-form">
            <input type="text" @bind=username placeholder="Username" class="login-input" />
            <input type="email" @bind=email placeholder="Email" class="login-input" />
            <input type="password" @bind=password placeholder="Password" class="login-input" />
            <input type="password" @bind=verifyPassword placeholder="Verify Password" class="login-input" />
            <button class="create-account-button" @onclick="CreateAccount">Create New Account</button>
        </div>
        <div class="status-message">
            @status
        </div>
    </div>
    <footer class="landing-footer">
        <div class="footer-links">
            <a href="#">About</a>
        </div>
        <div class="copyright">
            CodeChat © 2025
        </div>
    </footer>
</div>

@code {
    private string? username;
    private string? password;
    private string? verifyPassword;
    private string? email;
    private byte[]? publicKey;
    private string status = string.Empty;
    private HubConnection? connection;

    protected override async Task OnInitializedAsync()
    {
        await InitializeSignalR();
    }

    private async Task InitializeSignalR()
    {

        var hubUrl = Navigation.ToAbsoluteUri("/chathub");

        connection = new HubConnectionBuilder()
            .WithUrl(hubUrl, options =>
            {
                options.Transports = Microsoft.AspNetCore.Http.Connections.HttpTransportType.WebSockets;
                options.SkipNegotiation = true;
            })
            .WithAutomaticReconnect(new[] { TimeSpan.Zero, TimeSpan.FromSeconds(2), TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(10) })
            .Build();

        connection.On<string>("AccountCreationFailed", (message) => {
            status = message;
            StateHasChanged();
        });

        connection.On<string>("AccountCreationSuccess", (message) => {
            status = message;
            StateHasChanged();
        });

        await connection.StartAsync();
    }

    private async Task CreateAccount()
    {
        // check if passwords match
        // if (password != verifyPassword) {
        //     status = "Error: Passwords do not match.";
        //     return;
        // }


        if (connection is not null) // check if there is a connection to the hub
        {
            if (connection.State != HubConnectionState.Connected)
            {
                status = "Error: Connection not established. Please refresh the page.";
                StateHasChanged();
                return;
            }

            await GenerateKeyPairAsync();
            await Task.Delay(1000);
            if (publicKey == null) {
                status = "Error: Public key generation failed.";
                StateHasChanged();
                return;
            }
            var userCreated = await connection.InvokeAsync<Boolean>("CreateUser", username, email, password, verifyPassword);

            if (userCreated)
            {
                await Task.Delay(2000);
                // Redirects to the login page after short delay.  Success message handled below
                Navigation.NavigateTo("/");
            }
            else
            {
                return;
            }
        }
    }

    public async Task AuthenticateUser() {
        if (string.IsNullOrWhiteSpace(username) || string.IsNullOrWhiteSpace(password) || string.IsNullOrWhiteSpace(email)) {
            return;
        }
        if (connection is not null) {
            if (connection.State != HubConnectionState.Connected) {
                status = "Error: Connection not established. Please refresh the page.";
                StateHasChanged();
                return;
            }
            var userCreated = await connection.InvokeAsync<bool>("CreateUser", username, password, email, publicKey);
            await Task.Delay(1000);
            if (userCreated) {
                status = "Account created successfully!";
                // Optionally, redirect to the login page or show a success message
                Navigation.NavigateTo($"/dashboard/{username}");
            } else {
                status = "Error: Account creation failed. Please try again.";
                StateHasChanged();
                return;
            }
        }
        else
        {
            status = "Error: Connection not established. Please refresh the page.";
            StateHasChanged();
            return;
        }
    }

    public async Task GenerateKeyPairAsync() {
        if (_jsRuntime == null)
        {
            status = "Error: JavaScript runtime is not available.";
            StateHasChanged();
            return;
        }

        // Call the JavaScript function to generate a key pair
        var pubKey = await _jsRuntime.InvokeAsync<byte[]>("generateKeyPair");
        if (pubKey == null) {
            status = "Error: Key pair generation failed.";
            StateHasChanged();
            return;
        }
        publicKey = pubKey;
        
    }

    public bool IsConnected =>
       connection?.State == HubConnectionState.Connected;

    public async ValueTask DisposeAsync()
    {
        if (connection is not null)
        {
            await connection.DisposeAsync();
        }
    }
}
